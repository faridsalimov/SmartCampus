@page
@using SmartCampus.Web.Pages.Shared
@model SmartCampus.Web.Pages.Lessons.IndexModel
@{
    ViewData["Title"] = "Lessons";
    var isTeacher = User.IsInRole("Teacher");
    var isAdmin = User.IsInRole("Admin");
    var canCreate = User.IsInRole("Admin") || User.IsInRole("Teacher");
    var canEdit = isTeacher || isAdmin;
    var canDelete = isTeacher || isAdmin;

    var pageHeader = new PageHeaderModel
    {
        Title = "Lessons",
        Subtitle = isTeacher ? "Create and manage your lesson content" : "Browse and attend your lessons",
        IconClass = "fas fa-chalkboard",
        IconColor = "#5e5ce6",
        GradientStart = "rgba(94, 92, 230, 0.05)",
        GradientEnd = "rgba(0, 102, 255, 0.05)",
        BorderColor = "rgba(94, 92, 230, 0.1)",
        Actions = canCreate ? new()
        {
            new PageHeaderAction
            {
                Label = "New Lesson",
                Url = Url.Page("Create"),
                CssClass = "btn-primary",
                IconClass = "fas fa-plus"
            }
        } : new()
    };
}

<partial name="_PageHeader" model="pageHeader" />

@if (Model.Lessons != null && Model.Lessons.Count > 0)
{
    <div style="display: grid; gap: 18px;">
        @foreach (var lesson in Model.Lessons.OrderBy(l => l.LessonDate))
        {
            var isUpcoming = lesson.LessonDate > DateTime.Now;
            var statusColor = lesson.IsCompleted ? "#34c759" : isUpcoming ? "#5e5ce6" : "#a1a1a6";
            var statusLabel = lesson.IsCompleted ? "Completed" : isUpcoming ? "Upcoming" : "Past";

            <div class="card border-0" style="border-radius: 14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; overflow: hidden; border-left: 5px solid @statusColor;">
                <div class="card-body" style="padding: 20px;">
                    <div class="row align-items-center">
                        
                        <div class="col-md-7">
                            <div style="display: flex; align-items: flex-start; gap: 16px;">
                                
                                <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, @statusColor, @(statusColor == "#5e5ce6" ? "#0066ff" : statusColor)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; flex-shrink: 0;">
                                    <i class="fas fa-chalkboard"></i>
                                </div>

                                <div style="flex: 1;">
                                    
                                    <h4 style="font-weight: 700; color: #1d1d1f; margin: 0 0 6px 0; font-size: 1.1rem;">
                                        @lesson.Title
                                    </h4>
                                    
                                    <p style="color: #636366; font-size: 0.85rem; margin: 0 0 10px 0; display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-users" style="color: #5e5ce6;"></i>@lesson.CourseName
                                    </p>

                                    
                                    @if (!string.IsNullOrEmpty(lesson.Content))
                                    {
                                        <p style="color: #636366; font-size: 0.9rem; margin: 0; line-height: 1.5;">
                                            @Html.Raw(lesson.Content.Length > 120 ? lesson.Content.Substring(0, 120) + "..." : lesson.Content)
                                        </p>
                                    }

                                    
                                    <div style="margin-top: 10px;">
                                        <span style="display: inline-block; background: @(statusColor)20; color: @statusColor; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                            @if (lesson.IsCompleted)
                                            {
                                                <i class="fas fa-check-circle me-1"></i>
                                                <span>Completed</span>
                                            }
                                            else if (isUpcoming)
                                            {
                                                <i class="fas fa-calendar me-1"></i>
                                                <span>Upcoming</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-history me-1"></i>
                                                <span>Past</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        
                        <div class="col-md-5">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                
                                <div style="background: #f5f5f7; padding: 12px; border-radius: 10px;">
                                    <p style="color: #a1a1a6; font-size: 0.75rem; font-weight: 600; margin: 0 0 6px 0; text-transform: uppercase;">
                                        <i class="fas fa-calendar me-1"></i>Date & Time
                                    </p>
                                    <p style="color: #1d1d1f; font-weight: 600; margin: 0 0 4px 0;">
                                        @lesson.LessonDate.ToString("dddd, MMM dd")
                                    </p>
                                    <p style="color: #636366; font-size: 0.9rem; margin: 0;">
                                        <i class="fas fa-clock me-1"></i>@lesson.LessonDate.ToString("h:mm tt")
                                        @if (!string.IsNullOrEmpty(lesson.Location))
                                        {
                                            <span style="display: block; color: #636366; font-size: 0.85rem; margin-top: 4px;">
                                                <i class="fas fa-map-marker me-1"></i>@lesson.Location
                                            </span>
                                        }
                                    </p>
                                </div>

                                
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <a asp-page="Details" asp-route-id="@lesson.Id" class="btn btn-sm" style="background: #f5f5f7; color: #1d1d1f; border: 1px solid #e5e5ea; border-radius: 8px; padding: 9px 14px; font-weight: 500; transition: all 0.3s ease; flex: 1; min-width: 80px; text-align: center;">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>

                                    @if (isTeacher && !lesson.IsCompleted)
                                    {
                                        <a asp-page="Start" asp-route-id="@lesson.Id" class="btn btn-sm" style="background: linear-gradient(135deg, #34c759, #76d54d); color: white; border: none; border-radius: 8px; padding: 9px 14px; font-weight: 500; box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3); transition: all 0.3s ease; flex: 1; min-width: 110px; text-align: center;" title="Start lesson and take attendance">
                                            <i class="fas fa-play-circle me-1"></i>Start
                                        </a>
                                    }

                                    @if (canEdit)
                                    {
                                        <a asp-page="Edit" asp-route-id="@lesson.Id" class="btn btn-sm" style="background: #e0e7ff; color: #5e5ce6; border: 1px solid #d0d8ff; border-radius: 8px; padding: 9px 14px; font-weight: 500; transition: all 0.3s ease; flex: 0 1 auto; white-space: nowrap; text-align: center;" title="Edit lesson">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </a>
                                    }

                                    @if (canDelete)
                                    {
                                        <button type="button" class="btn btn-sm" style="background: #ffebee; color: #ff3b30; border: 1px solid #ffccd5; border-radius: 8px; padding: 9px 14px; font-weight: 500; transition: all 0.3s ease; flex: 0 1 auto; white-space: nowrap; text-align: center;" data-bs-toggle="modal" data-bs-target="#confirmModal" data-delete-url="@Url.Page("Index", new { handler = "Delete", id = lesson.Id })" data-delete-entity="@lesson.Id" title="Delete lesson">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div style="background: linear-gradient(135deg, rgba(94, 92, 230, 0.05) 0%, rgba(0, 102, 255, 0.05) 100%); border: 1px solid rgba(94, 92, 230, 0.1); border-radius: 12px; padding: 40px; text-align: center;">
        <div style="font-size: 3rem; color: #5e5ce6; opacity: 0.3; margin-bottom: 16px;">
            <i class="fas fa-book-open"></i>
        </div>
        <h4 style="color: #1d1d1f; font-weight: 600; margin-bottom: 8px;">No Lessons Found</h4>
        <p style="color: #636366; margin-bottom: 0;">@(isTeacher ? "You haven't created any lessons yet." : "No lessons available.")</p>
        @if (canCreate)
        {
            <a asp-page="Create" class="btn" style="margin-top: 15px; background: #5e5ce6; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 500;">
                <i class="fas fa-plus me-1"></i>Create First Lesson
            </a>
        }
    </div>
}

<partial name="_ConfirmModal" />
